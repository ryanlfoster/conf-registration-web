"use strict";angular.module("confRegistrationWebApp",["ngRoute","ngCookies","ui.bootstrap","ui.sortable","wysiwyg.module"]).config(function($routeProvider,$injector){$routeProvider.when("/",{templateUrl:"views/a390afa5.a390afa5.landing.html",controller:"landingCtrl"}).when("/register/:conferenceId",{resolve:{redirect:["$location","$route",function($location,$route){$location.path("/register/"+$route.current.params.conferenceId+"/page/")}]}}).when("/register/:conferenceId/page/:pageId?",{templateUrl:"views/8e9437b0.8e9437b0.registration.html",controller:"RegistrationCtrl",resolve:{enforceAuth:$injector.get("enforceAuth"),conference:["$route","ConfCache",function($route,ConfCache){return ConfCache.get($route.current.params.conferenceId)}],currentRegistration:["$route","RegistrationCache",function($route,RegistrationCache){return RegistrationCache.getCurrent($route.current.params.conferenceId)}]}}).when("/approvePayment/:paymentHash",{templateUrl:"views/b27ae159.b27ae159.paymentApproval.html",controller:"PaymentApprovalCtrl",resolve:{enforceAuth:$injector.get("enforceAuth")}}).when("/reviewRegistration/:conferenceId",{templateUrl:"views/22f621fd.22f621fd.reviewRegistration.html",controller:"ReviewRegistrationCtrl",resolve:{enforceAuth:$injector.get("enforceAuth"),registration:["$route","RegistrationCache",function($route,RegistrationCache){return RegistrationCache.emptyCache(),RegistrationCache.getCurrent($route.current.params.conferenceId).then(function(currentRegistration){return currentRegistration})}],conference:["$route","ConfCache",function($route,ConfCache){return ConfCache.get($route.current.params.conferenceId)}]}}).when("/preview/:conferenceId/page/:pageId?",{templateUrl:"views/8e9437b0.8e9437b0.registration.html",controller:"RegistrationCtrl",resolve:{enforceAuth:$injector.get("enforceAuth"),conference:["$route","ConfCache",function($route,ConfCache){return ConfCache.get($route.current.params.conferenceId)}],currentRegistration:["$route","RegistrationCache",function($route,RegistrationCache){return RegistrationCache.getCurrent($route.current.params.conferenceId)}]}}).when("/eventDashboard",{templateUrl:"views/75b6be28.75b6be28.eventDashboard.html",controller:"eventDashboardCtrl",resolve:{enforceAuth:$injector.get("enforceAuth")}}).when("/eventOverview/:conferenceId",{templateUrl:"views/1e3075af.1e3075af.eventOverview.html",controller:"eventOverviewCtrl",resolve:{enforceAuth:$injector.get("enforceAuth"),conference:["$route","ConfCache",function($route,ConfCache){return ConfCache.get($route.current.params.conferenceId)}],permissions:["$route","PermissionCache",function($route,PermissionCache){return PermissionCache.getForConference($route.current.params.conferenceId)}]}}).when("/eventRegistrations/:conferenceId",{templateUrl:"views/53770924.53770924.eventRegistrations.html",controller:"eventRegistrationsCtrl",resolve:{enforceAuth:$injector.get("enforceAuth"),registrations:["$route","RegistrationCache",function($route,RegistrationCache){var visibleBlocks=localStorage.getItem("visibleBlocks:"+$route.current.params.conferenceId);return _.isNull(visibleBlocks)||(visibleBlocks=JSON.parse(visibleBlocks)),RegistrationCache.getAllForConference($route.current.params.conferenceId,visibleBlocks)}],conference:["$route","ConfCache",function($route,ConfCache){return ConfCache.get($route.current.params.conferenceId)}],permissions:["$route","PermissionCache",function($route,PermissionCache){return PermissionCache.getForConference($route.current.params.conferenceId)}]}}).when("/eventForm/:conferenceId",{template:'<ng-include src="templateUrl"></ng-include>',controller:"eventFormCtrl",resolve:{enforceAuth:$injector.get("enforceAuth"),conference:["$route","ConfCache",function($route,ConfCache){return ConfCache.get($route.current.params.conferenceId)}],permissions:["$route","PermissionCache",function($route,PermissionCache){return PermissionCache.getForConference($route.current.params.conferenceId)}]}}).when("/eventDetails/:conferenceId",{template:'<ng-include src="templateUrl"></ng-include>',controller:"eventDetailsCtrl",resolve:{enforceAuth:$injector.get("enforceAuth"),conference:["$route","ConfCache",function($route,ConfCache){return ConfCache.get($route.current.params.conferenceId)}],permissions:["$route","PermissionCache",function($route,PermissionCache){return PermissionCache.getForConference($route.current.params.conferenceId)}]}}).when("/eventPermissions/:conferenceId",{template:'<ng-include src="templateUrl"></ng-include>',controller:"eventPermissionsCtrl",resolve:{enforceAuth:$injector.get("enforceAuth"),conference:["$route","ConfCache",function($route,ConfCache){return ConfCache.get($route.current.params.conferenceId)}],permissions:["$route","PermissionCache",function($route,PermissionCache){return PermissionCache.getForConference($route.current.params.conferenceId)}]}}).when("/activatePermission/:permissionAuthCode",{template:"{{message}}",controller:"ActiviatePermissionCtrl",resolve:{enforceAuth:$injector.get("enforceAuth")}}).when("/auth/:token",{resolve:{redirectToIntendedRoute:["$location","$cookies","$route","$rootScope","ProfileCache",function($location,$cookies,$route,$rootScope,ProfileCache){$cookies.crsAuthProviderType="",$cookies.crsToken&&$cookies.crsToken!==$route.current.params.token&&($cookies.crsPreviousToken=$cookies.crsToken),$cookies.crsToken=$route.current.params.token,$rootScope.crsToken=$cookies.crsToken,ProfileCache.getCache(function(data){$cookies.crsAuthProviderType=data.authProviderType,angular.isDefined($cookies.regType)?($location.path($cookies.intendedRoute||"/").search("regType",$cookies.regType),delete $cookies.regType):$location.path($cookies.intendedRoute||"/")})}]}}).when("/logout/",{resolve:{redirect:["$location","$cookies","$window","$http",function($location,$cookies,$window,$http){if("RELAY"===$cookies.crsAuthProviderType){delete $cookies.crsAuthProviderType,delete $cookies.crsPreviousToken,delete $cookies.crsToken;var serviceUrl=$location.absUrl().replace("logout","");$window.location.href="https://signin.cru.org/cas/logout?service="+serviceUrl}else"FACEBOOK"===$cookies.crsAuthProviderType?$http.get("/auth/facebook/logout").success(function(data,status,headers){delete $cookies.crsAuthProviderType,delete $cookies.crsPreviousToken,delete $cookies.crsToken,$window.location.href=headers("X-Facebook-Logout-URL")}).error(function(data,status){alert("Logout failed: "+status)}):(delete $cookies.crsAuthProviderType,delete $cookies.crsPreviousToken,delete $cookies.crsToken,$location.url("/#"))}]}}).when("/help/",{templateUrl:"views/d4943981.d4943981.help.html",controller:"landingCtrl"}).when("/privacy/",{templateUrl:"views/fa286be4.fa286be4.privacy.html",controller:"landingCtrl"}).otherwise({redirectTo:"/"})}).run(function($rootScope,$cookies,$location,$window){$rootScope.$on("$locationChangeStart",function(){_.contains($location.path(),"/preview/")?$rootScope.registerMode="preview":_.contains($location.path(),"/register/")&&($rootScope.registerMode="register")}),$rootScope.$on("$routeChangeSuccess",function(){$window.scrollTo(0,0),$window.ga("send","pageview",{page:$location.path()})}),$rootScope.generateTitle=function(title){return title?title+" | Event Registration Tool":"Event Registration Tool"}}).config(function($httpProvider){$httpProvider.interceptors.push("currentRegistrationInterceptor"),$httpProvider.interceptors.push("httpUrlInterceptor"),$httpProvider.interceptors.push("authorizationInterceptor"),$httpProvider.interceptors.push("unauthorizedInterceptor"),$httpProvider.interceptors.push("debouncePutsInterceptor"),$httpProvider.interceptors.push("statusInterceptor")}),angular.module("confRegistrationWebApp").controller("ActiviatePermissionCtrl",function($scope,$route,$http,$location,$timeout){var permissionAuthCode=$route.current.params.permissionAuthCode;$scope.message="Verifying Auth Code...",$http({method:"PUT",url:"permissions/"+permissionAuthCode+"/accept",data:"{}"}).success(function(){$scope.message="Success! Permission has been granted.  Redirecting now...",$timeout(function(){$location.path("/")},2e3)}).error(function(data,status){404===status?$scope.message="Error: Permission auth code was not found.":403===status&&($scope.message="Error: Permission auth code has already been used or is more than 2 months old.")})}),angular.module("confRegistrationWebApp").controller("confirmCtrl",function($scope,ConfCache,$modalInstance){$scope.close=function(){$modalInstance.close(!1)},$scope.submit=function(){$modalInstance.close(!0)}}),angular.module("confRegistrationWebApp").controller("confirmPromptCtrl",function($scope,$modalInstance){$scope.close=function(){$modalInstance.close("")},$scope.submit=function(newPageName){$modalInstance.close(newPageName)}}),angular.module("confRegistrationWebApp").controller("createEventCtrl",function($scope,ConfCache,$modalInstance,defaultValue){$scope.name=defaultValue,$scope.close=function(){$modalInstance.close("")},$scope.submit=function(newConfName){$modalInstance.close(newConfName)}}),angular.module("confRegistrationWebApp").controller("deleteRegistrationCtrl",function($scope,ConfCache,$modalInstance){$scope.close=function(){$modalInstance.close(!1)},$scope["delete"]=function(){$modalInstance.close(!0)}}),angular.module("confRegistrationWebApp").controller("editRegistrationModalCtrl",function($scope,$modalInstance,$http,conference,registrant,registration){$scope.conference=angular.copy(conference),$scope.adminEditRegistration=angular.copy(registrant),$scope.registration=angular.copy(registration),$scope.saving=!1;var answersToUpdate=[];$scope.close=function(){$modalInstance.dismiss()},angular.forEach(angular.copy(conference.registrationPages),function(page){var pageIndex=_.findIndex($scope.conference.registrationPages,{id:page.id});angular.forEach(angular.copy(page.blocks),function(block){(_.contains(block.registrantTypes,registrant.registrantTypeId)||"paragraphContent"===block.type)&&_.remove($scope.conference.registrationPages[pageIndex].blocks,function(b){return b.id===block.id})}),0===$scope.conference.registrationPages[pageIndex].blocks.length&&_.remove($scope.conference.registrationPages,function(p){return p.id===page.id})}),$scope.submit=function(setRegistrationAsCompleted){if($scope.saving=!0,angular.forEach($scope.adminEditRegistration.answers,function(a){angular.equals(a,_.find(registrant.answers,{id:a.id}))||answersToUpdate.push(a)}),setRegistrationAsCompleted){var r=confirm("Are you sure you want to mark this registration as completed?");if(!r)return void($scope.saving=!1);$scope.registration.completed=!0,$http.put("registrations/"+registrant.registrationId,$scope.registration).success(function(){saveAnswer()})}else saveAnswer()};var saveAnswer=function(){if(answersToUpdate.length){var a=_.first(answersToUpdate);answersToUpdate.shift(),$http.put("answers/"+a.id,a).success(saveAnswer)}else $http.get("registrations/"+registrant.registrationId).success(function(registration){$modalInstance.close(registration)})}}),angular.module("confRegistrationWebApp").controller("eventDashboardCtrl",function($rootScope,$scope,ConfCache,RegistrationCache,$modal,$location,$http,Model,uuid){$rootScope.globalPage={type:"admin",mainClass:"container dashboard",bodyClass:"",title:"My Dashboard",confId:0,footer:!0},$scope.$on("conferences/",function(event,conferences){$scope.conferences=conferences}),ConfCache.query(),$scope.$watch("showArchivedEvents",function(v){$scope.showArchivedEventsFilter=v?"":!1}),$scope.createEvent=function(){$modal.open({templateUrl:"views/modals/0c5b6712.0c5b6712.createEvent.html",controller:"createEventCtrl",resolve:{defaultValue:function(){return""}}}).result.then(function(conferenceName){null===conferenceName||""===conferenceName||angular.isUndefined(conferenceName)||ConfCache.create(conferenceName).then(function(conference){$location.path("/eventDetails/"+conference.id)})})},$scope.goToEventPage=function(page,eventId){var eventData=_.find($scope.conferences,{id:eventId});eventData.archived||$location.path("/"+page+"/"+eventId)},$scope.restoreEvent=function(eventId){var eventData=_.find($scope.conferences,{id:eventId});eventData.archived=!1,$http({method:"PUT",url:"conferences/"+eventId,data:eventData}).success(function(){ConfCache.empty()}).error(function(data){alert("Error: "+data),eventData.archived=!0})},$scope.cloneEvent=function(conferenceToCloneId){var conferenceToClone=_.find($scope.conferences,{id:conferenceToCloneId});$modal.open({templateUrl:"views/modals/1362b23c.1362b23c.cloneEvent.html",controller:"createEventCtrl",resolve:{defaultValue:function(){return conferenceToClone.name+" (clone)"}}}).result.then(function(conferenceName){null===conferenceName||""===conferenceName||angular.isUndefined(conferenceName)||ConfCache.create(conferenceName).then(function(conference){var conferenceOrig=conference;$http.get("conferences/"+conferenceToClone.id).success(function(result){conference=angular.copy(result),conference.id=conferenceOrig.id,conference.name=conferenceName;for(var registrantTypeIdMap={},i=0;i<conference.registrantTypes.length;i++){var originalRegTypeId=conference.registrantTypes[i].id,clonedRegTypeId=uuid();registrantTypeIdMap[originalRegTypeId]=clonedRegTypeId,conference.registrantTypes[i].id=clonedRegTypeId,conference.registrantTypes[i].conferenceId=conference.id}for(conference.registrationPages=result.registrationPages,i=0;i<conference.registrationPages.length;i++){var pageUuid=uuid();conference.registrationPages[i].id=pageUuid,conference.registrationPages[i].conferenceId=conference.id;for(var j=0;j<conference.registrationPages[i].blocks.length;j++){conference.registrationPages[i].blocks[j].id=uuid(),conference.registrationPages[i].blocks[j].pageId=pageUuid;var originalRegTypeIds=angular.copy(conference.registrationPages[i].blocks[j].registrantTypes);conference.registrationPages[i].blocks[j].registrantTypes=[];for(var k=0;k<originalRegTypeIds.length;k++){var id=originalRegTypeIds[k];conference.registrationPages[i].blocks[j].registrantTypes.push(registrantTypeIdMap[id])}}}Model.update("conferences/"+conference.id,conference,function(){$location.path("/eventDetails/"+conference.id)})})})})}}),angular.module("confRegistrationWebApp").controller("eventDetailsCtrl",function($rootScope,$scope,$http,$sce,$timeout,$window,$modal,$filter,conference,ConfCache,permissions,permissionConstants,uuid){$rootScope.globalPage={type:"admin",mainClass:"container conference-details",bodyClass:"",title:conference.name,confId:conference.id,footer:!0},$scope.templateUrl=permissions.permissionInt>=permissionConstants.UPDATE?"views/540b13b1.540b13b1.eventDetails.html":"views/2c2a6d65.2c2a6d65.permissionError.html",$scope.tabs=[{id:"eventInfo",name:"Event Information",view:"views/eventDetails/763e9848.763e9848.eventInformation.html"},{id:"regOptions",name:"Registration Options",view:"views/eventDetails/5c9e324d.5c9e324d.regOptions.html"},{id:"regTypes",name:"Registration Types",view:"views/eventDetails/c1bfe3cb.c1bfe3cb.regTypes.html"},{id:"paymentOptions",name:"Payment Options",view:"views/eventDetails/f7803c9c.f7803c9c.paymentOptions.html"},{id:"contactInfo",name:"Contact Information",view:"views/eventDetails/94bb7c26.94bb7c26.contactInfo.html"}],$scope.changeTab=function(tab){$scope.activeTab=tab},$scope.changeTab($scope.tabs[0]),$scope.paymentGateways=[{id:"AUTHORIZE_NET",name:"Authorize.Net"},{id:"TRUST_COMMERCE",name:"TrustCommerce"}],$scope.conference=angular.copy(conference),$scope.addRegType=function(){$scope.conference.registrantTypes.push({id:uuid(),cost:0,earlyRegistrationCutoff:moment().add(7,"days").format("YYYY-MM-DD HH:mm:ss")})},$scope.deleteRegType=function(id){$scope.conference.registrantTypes.length>1?_.remove($scope.conference.registrantTypes,function(type){return type.id===id}):($scope.notify={"class":"alert-danger",message:$sce.trustAsHtml("You must have at least one registration type per event.")},$timeout(function(){$scope.notify={}},3500))},$scope.saveEvent=function(){var validationErrors=[];if(_.isEmpty($scope.conference.name)&&validationErrors.push("Please enter an event name."),$scope.conference.eventStartTime>$scope.conference.eventEndTime&&validationErrors.push("Event end date/time must be after event start date/time."),$scope.conference.registrationStartTime>$scope.conference.registrationEndTime&&validationErrors.push("Registration end date/time must be after registration start date/time."),$scope.conference.acceptCreditCards&&_.isEmpty($scope.conference.paymentGatewayId)&&validationErrors.push("Please enter a merchant account ID."),angular.forEach($scope.conference.registrantTypes,function(t){_.isEmpty(t.name)&&validationErrors.push("Please enter a name for all registration types.")}),angular.forEach($scope.conference.registrantTypes,function(t){t.cost=Number(t.cost),(_.isNaN(t.cost)||t.cost<0)&&validationErrors.push("Event cost for '"+t.name+"' must be a positive number.")}),angular.forEach($scope.conference.registrantTypes,function(t){$scope.conference.requireLogin&&$scope.anyPaymentMethodAccepted()&&String(t.minimumDeposit).length>0&&!_.isNull(t.minimumDeposit)?(t.minimumDeposit=Number(t.minimumDeposit),t.minimumDeposit>t.cost&&validationErrors.push("The minimum deposit for '"+t.name+"' must be less than the cost.")):t.minimumDeposit=null}),angular.forEach($scope.conference.registrantTypes,function(t){t.earlyRegistrationDiscount&&(t.earlyRegistrationAmount=Number(t.earlyRegistrationAmount),t.earlyRegistrationAmount>t.cost&&validationErrors.push("The early registration discount for '"+t.name+"' must be less than the cost."),t.earlyRegistrationAmount<0&&validationErrors.push("The early registration discount for '"+t.name+"' must be a positive number."))}),$window.scrollTo(0,0),validationErrors.length>0){var errorMsg="<strong>Error!</strong> Please fix the following issues:<ul>";angular.forEach(validationErrors,function(e){errorMsg=errorMsg+"<li>"+e+"</li>"}),errorMsg+="</ul>",$scope.notify={"class":"alert-danger",message:$sce.trustAsHtml(errorMsg)}}else $scope.notify={"class":"alert-warning",message:$sce.trustAsHtml("Saving...")},$http({method:"PUT",url:"conferences/"+conference.id,data:$scope.conference}).success(function(){$scope.notify={"class":"alert-success",message:$sce.trustAsHtml("<strong>Saved!</strong> Your event details have been updated.")},ConfCache.empty()}).error(function(data){window.scrollTo(0,0),$scope.notify={"class":"alert-danger",message:$sce.trustAsHtml("<strong>Error</strong> "+data)}})},$scope.anyPaymentMethodAccepted=function(){return $scope.conference.acceptCreditCards||$scope.conference.acceptChecks||$scope.conference.acceptTransfers||conference.acceptScholarships},$scope.previewEmail=function(reg){var cost=$filter("moneyFormat")(reg.cost),eventStartTime=moment(conference.eventStartTime).format("dddd, MMMM D YYYY, h:mm a"),eventEndTime=moment(conference.eventEndTime).format("dddd, MMMM D YYYY, h:mm a");$modal.open({template:'<div class="modal-header"><button type="button" class="close" ng-click="close()" aria-hidden="true">&times;</button><h4>Email Preview</h4></div><div class="modal-body"><p>Hello '+$rootScope.globalGreetingName+"!</p><p>You are registered for "+$scope.conference.name+".</p><p><strong>Start Time:</strong> "+eventStartTime+"<br><strong>End Time:</strong> "+eventEndTime+"</p><p><strong>Total Cost:</strong> "+cost+"<br><strong>Total Amount Paid:</strong> "+cost+"<br><strong>Remaining Balance:</strong> $0.00</p>"+reg.customConfirmationEmailText+"</div>",controller:"genericModal",resolve:{data:function(){return""}}})}}),angular.module("confRegistrationWebApp").controller("eventFormCtrl",function($rootScope,$scope,$modal,$location,$sce,$http,$timeout,conference,GrowlService,ConfCache,uuid,permissions,permissionConstants){$rootScope.globalPage={type:"admin",mainClass:"container form-builder",bodyClass:"small-footer",title:conference.name,confId:conference.id,footer:!0},$scope.templateUrl=permissions.permissionInt>=permissionConstants.UPDATE?"views/27ec9ef7.27ec9ef7.eventForm.html":"views/2c2a6d65.2c2a6d65.permissionError.html",$scope.conference=conference,$scope.$watch("conference",function(newObject,oldObject){angular.isDefined(newObject)&&angular.isDefined(oldObject)&&(_.isEqual(newObject,oldObject)||saveForm())},!0);var formSavingTimeout,formSavingNotifyTimeout,formSaving=!1,saveForm=function(){return formSaving?($timeout.cancel(formSavingTimeout),void(formSavingTimeout=$timeout(function(){saveForm()},600))):($timeout.cancel(formSavingTimeout),formSaving=!0,void $http({method:"PUT",url:"conferences/"+conference.id,data:$scope.conference}).success(function(){formSaving=!1,$scope.notify={"class":"alert-success",message:$sce.trustAsHtml("<strong>Saved!</strong> Your form has been saved.")},angular.isDefined($scope.conference)&&ConfCache.update(conference.id,$scope.conference),$timeout.cancel(formSavingNotifyTimeout),formSavingNotifyTimeout=$timeout(function(){$scope.notify={}},2e3)}).error(function(data){formSaving=!1,$scope.notify={"class":"alert-danger",message:$sce.trustAsHtml("<strong>Error</strong> "+data)}}))};$scope.previewForm=function(){$location.path("/preview/"+conference.id+"/page/")},$scope.deletePage=function(pageId,growl){var delPageIndex=_.findIndex($scope.conference.registrationPages,{id:pageId});if($scope.conference.registrationPages[delPageIndex].blocks.length>0)return void $modal.open({templateUrl:"views/modals/3d754af3.3d754af3.errorModal.html",controller:"genericModal",resolve:{data:function(){return"Please remove all questions from page before deleting."}}});if(growl){var page=_.find($scope.conference.registrationPages,{id:pageId}),message='Page "'+page.title+'" has been deleted.';GrowlService.growl($scope,"conference",$scope.conference,message)}$scope.conference.registrationPages.splice(delPageIndex,1)};var makePositionArray=function(){var tempPositionArray=[];return $scope.conference.registrationPages.forEach(function(page,pageIndex){page.blocks.forEach(function(block,blockIndex){tempPositionArray[block.id]={page:pageIndex,block:blockIndex}})}),tempPositionArray};$scope.moveBlock=function(blockId,newPage,newPosition){var tempPositionArray=makePositionArray(),newPageIndex=_.findIndex($scope.conference.registrationPages,{id:newPage}),origPageIndex=tempPositionArray[blockId].page,origBlock=angular.copy($scope.conference.registrationPages[origPageIndex].blocks[tempPositionArray[blockId].block]);origBlock.pageId=newPage,deleteBlockFromPage(blockId),$scope.conference.registrationPages[newPageIndex].blocks.splice(newPosition,0,origBlock)},$scope.copyBlock=function(blockId){var tempPositionArray=makePositionArray(),origPageIndex=tempPositionArray[blockId].page,newBlock=angular.copy($scope.conference.registrationPages[origPageIndex].blocks[tempPositionArray[blockId].block]),newPosition=tempPositionArray[blockId].block+1;newBlock.id=uuid(),newBlock.profileType=null,newBlock.position=newPosition,newBlock.title=newBlock.title+" (copy)",$scope.conference.registrationPages[origPageIndex].blocks.splice(newPosition,0,newBlock)},$scope.insertBlock=function(blockType,newPage,newPosition,title,defaultProfile){var newPageIndex=_.findIndex($scope.conference.registrationPages,{id:newPage}),profileType=null;if(angular.isDefined(defaultProfile)){var profileCount=0;$scope.conference.registrationPages.forEach(function(page){page.blocks.forEach(function(block){defaultProfile===block.profileType&&profileCount++})}),0===profileCount&&(profileType=defaultProfile)}var newBlock={id:uuid(),content:"",pageId:newPage,required:!1,title:title,type:blockType,profileType:profileType};$scope.$apply(function(){$scope.conference.registrationPages[newPageIndex].blocks.splice(newPosition,0,newBlock)})},$scope.deleteBlock=function(blockId,growl){if(growl){var t=makePositionArray(),block=$scope.conference.registrationPages[t[blockId].page].blocks[t[blockId].block],message='"'+block.title+'" has been deleted.';GrowlService.growl($scope,"conference",$scope.conference,message)}deleteBlockFromPage(blockId)};var deleteBlockFromPage=function(blockId){var tempPositionArray=makePositionArray();_.remove($scope.conference.registrationPages[tempPositionArray[blockId].page].blocks,function(b){return b.id===blockId})};$scope.addNewPage=function(){$modal.open({templateUrl:"views/modals/b283bffc.b283bffc.promptNewPage.html",controller:"confirmPromptCtrl"}).result.then(function(pageTitle){null===pageTitle||""===pageTitle||angular.isUndefined(pageTitle)||$scope.conference.registrationPages.push({id:uuid(),conferenceId:$scope.conference.id,position:0,title:pageTitle,blocks:[]})})};var hiddenPages=[];$scope.togglePage=function(id){_.contains(hiddenPages,id)?_.remove(hiddenPages,function(p){return p===id}):hiddenPages.push(id)},$scope.isPageHidden=function(id){return _.contains(hiddenPages,id)},$scope.movePage=function(pageId,newPosition){var origPageIndex=_.findIndex($scope.conference.registrationPages,{id:pageId}),origPage=$scope.conference.registrationPages[origPageIndex];$scope.$apply(function(scope){scope.conference.registrationPages.splice(origPageIndex,1),scope.conference.registrationPages.splice(newPosition,0,origPage)})}}),angular.module("confRegistrationWebApp").controller("eventOverviewCtrl",function($rootScope,$scope,$location,$route,ConfCache,conference){$rootScope.globalPage={type:"admin",mainClass:"container conference-details",bodyClass:"",title:conference.name,confId:conference.id,footer:!0},$scope.conference=conference;var port="";80!==$location.$$port&&443!==$location.$$port&&(port=":"+$location.$$port);var baseUrl=$location.$$protocol+"://"+$location.$$host+port+"/#/register/"+conference.id;$scope.registrationUrl={},$scope.registrationUrl[0]=baseUrl,angular.forEach(conference.registrantTypes,function(t){$scope.registrationUrl[t.id]=baseUrl+"?regType="+t.id})}),angular.module("confRegistrationWebApp").controller("eventPermissionsCtrl",function($rootScope,$scope,$http,$sce,conference,permissions,permissionConstants){$rootScope.globalPage={type:"admin",mainClass:"container conference-details",bodyClass:"",title:conference.name,confId:conference.id,footer:!0},$scope.templateUrl=permissions.permissionInt>=permissionConstants.FULL?"views/e9bb45a5.e9bb45a5.eventPermissions.html":"views/2c2a6d65.2c2a6d65.permissionError.html",$scope.conference=conference;var getPermissions=function(){$http({method:"GET",url:"conferences/"+conference.id+"/permissions"}).success(function(data){$scope.currentPermissions=data}).error(function(){})};getPermissions(),$scope.updatePermission=function(id){$http({method:"PUT",url:"permissions/"+id,data:_.find($scope.currentPermissions,{id:id})}).success(function(){$scope.notify={"class":"alert-success",message:$sce.trustAsHtml("User updated.")}}).error(function(data){$scope.notify={"class":"alert-danger",message:$sce.trustAsHtml("Error: "+data)}})},$scope.addPermission=function(addPermissionsEmail,addPermissionsLevel){var postData={conferenceId:conference.id,emailAddress:addPermissionsEmail,permissionLevel:addPermissionsLevel};$http({method:"POST",url:"conferences/"+conference.id+"/permissions",data:postData}).success(function(){getPermissions(),$scope.$$childHead.addPermissionsEmail="",$scope.$$childHead.addPermissionsLevel="",$scope.notify={"class":"alert-success",message:$sce.trustAsHtml("User added.")}}).error(function(data){$scope.notify={"class":"alert-danger",message:$sce.trustAsHtml("Error: "+data)}})},$scope.deletePermission=function(id){$http({method:"DELETE",url:"permissions/"+id}).success(function(){getPermissions(),$scope.notify={"class":"alert-success",message:$sce.trustAsHtml("User removed.")}}).error(function(data){$scope.notify={"class":"alert-danger",message:$sce.trustAsHtml("Error: "+data)}})}}),angular.module("confRegistrationWebApp").controller("eventRegistrationsCtrl",function($rootScope,$scope,$modal,$http,RegistrationCache,registrations,conference,permissions){$rootScope.globalPage={type:"admin",mainClass:"registrations",bodyClass:"",title:conference.name,confId:conference.id,footer:!0},$scope.conference=conference,$scope.blocks=[],$scope.reversesort=!1,$scope.order="name",$scope.showRegistrationsCompleted=1,$scope.filterRegistrantType="",$scope.visibleFilterRegistrantTypes=_.sortBy(conference.registrantTypes,"name"),$scope.visibleFilterRegistrantTypes.unshift({id:"",name:"-Any-"});var expandedRegistrations={};$scope.registrations=registrations,$scope.registrants=_.flatten(registrations,"registrants"),angular.forEach(conference.registrationPages,function(page){angular.forEach(page.blocks,function(block){"paragraphContent"!==block.type&&$scope.blocks.push(angular.copy(block))})});var visibleBlocks=localStorage.getItem("visibleBlocks:"+conference.id);_.isNull(visibleBlocks)||(visibleBlocks=JSON.parse(visibleBlocks),angular.forEach(visibleBlocks,function(blockId){var block=_.find($scope.blocks,{id:blockId});angular.isDefined(block)&&(block.visible=!0)})),$scope.toggleColumn=function(block){$scope.blocks[block].visible=!$scope.blocks[block].visible;var visibleBlocks=_.pluck(_.where($scope.blocks,{visible:!0}),"id");localStorage.setItem("visibleBlocks:"+conference.id,JSON.stringify(visibleBlocks)),$scope.blocks[block].visible&&RegistrationCache.getAllForConference(conference.id,visibleBlocks).then(function(registrations){$scope.registrations=registrations,$scope.registrants=_.flatten(registrations,"registrants"),expandedRegistrations={}})},$scope.blockIsVisible=function(block,registrantTypeId){return!_.contains(block.registrantTypes,registrantTypeId)};var findAnswer=function(registration,blockId){return _.find(registration.answers,function(answer){return angular.equals(answer.blockId,blockId)})};$scope.answerSort=function(registration){if(!angular.isDefined($scope.order))return 0;if("completed"===$scope.order)return $scope.getRegistration(registration.registrationId).completedTimestamp;if("created"===$scope.order)return $scope.getRegistration(registration.registrationId).createdTimestamp;if("type"===$scope.order)return $scope.getRegistrantType(registration.registrantTypeId).name;if("name"===$scope.order)return registration.firstName+registration.lastName;if("email"===$scope.order)return registration.email;if(angular.isDefined(findAnswer(registration,$scope.order))){var answerValue=findAnswer(registration,$scope.order).value;return _.isObject(answerValue)?_.values(findAnswer(registration,$scope.order).value).join(" "):answerValue}},$scope.setOrder=function(order){$scope.reversesort=order===$scope.order?!$scope.reversesort:!1,$scope.order=order},$scope.viewPayments=function(registrationId){var paymentModalOptions={templateUrl:"views/modals/82f6383d.82f6383d.paymentsModal.html",controller:"paymentModal",size:"lg",backdrop:"static",resolve:{registration:function(){return _.find(registrations,{id:registrationId})},conference:function(){return conference}}};$modal.open(paymentModalOptions).result.then(function(updatedRegistration){var localUpdatedRegistrationIndex=_.findIndex($scope.registrations,{id:updatedRegistration.id});$scope.registrations[localUpdatedRegistrationIndex]=updatedRegistration})},$scope.paymentCategories=[{name:"-Any-",matches:function(){return!0}},{name:"Full/Overpaid",matches:function(x,y){return x>=y}},{name:"Partial",matches:function(x,y){return x>0&&y>x}},{name:"Full/Partial",matches:function(x){return x>0}},{name:"Not Paid",matches:function(x){return null===x?!0:0>=x}},{name:"Overpaid",matches:function(x,y){return x>y}}],$scope.currentPaymentCategory=_.first($scope.paymentCategories).name,$scope.paymentStatus=function(registrant){var registration=_.find(registrations,{id:registrant.registrationId}),paymentCategory=_.find($scope.paymentCategories,{name:$scope.currentPaymentCategory});return paymentCategory.matches(registration.totalPaid,registration.calculatedTotalDue)},$scope.completeStatus=function(registrant){var registration=_.find(registrations,{id:registrant.registrationId});return $scope.showRegistrationsCompleted?registration.completed:!0},$scope.paidInFull=function(registrantId){var registration=_.find(registrations,{id:registrantId});
return registration.totalPaid>=registration.calculatedTotalDue},$scope.expandRegistration=function(r){"open"===expandedRegistrations[r]?delete expandedRegistrations[r]:(expandedRegistrations[r]="loading",$http.get("registrants/"+r).success(function(registrantData){expandedRegistrations[r]="open";var index=_.findIndex($scope.registrants,{id:registrantData.id});$scope.registrants[index]=registrantData,index=_.findIndex($scope.registrations,{id:registrantData.registrationId});var registrantIndex=_.findIndex($scope.registrations[index].registrants,{id:registrantData.id});$scope.registrations[index].registrants[registrantIndex]=registrantData}).error(function(){alert("Error: registrant data could be be retrieved."),delete expandedRegistrations[r]}))},$scope.expandedStatus=function(r){return expandedRegistrations[r]},$scope.editRegistrant=function(r){$http.get("registrants/"+r).success(function(registrantData){var registration=_.find($scope.registrations,{id:registrantData.registrationId}),editRegistrationDialogOptions={templateUrl:"views/modals/3cb83c8e.3cb83c8e.editRegistration.html",controller:"editRegistrationModalCtrl",resolve:{registrant:function(){return registrantData},registration:function(){return registration},conference:function(){return conference}}};$modal.open(editRegistrationDialogOptions).result.then(function(registration){var index=_.findIndex($scope.registrations,{id:registration.id});$scope.registrations[index]=registration,r=_.find(registration.registrants,{id:r}),index=_.findIndex($scope.registrants,{id:r.id}),$scope.registrants[index]=r})}).error(function(){alert("Error: registrant data could be be retrieved."),delete expandedRegistrations[r]})},$scope["export"]=function(){$modal.open({templateUrl:"views/modals/cb25e0b6.cb25e0b6.export.html",controller:"exportDataModal",resolve:{conference:function(){return $scope.conference},hasCost:function(){return $scope.eventHasCost()}}})},$scope.eventHasCost=function(){return _.max(_.flatten(conference.registrantTypes,"cost"))>0},$scope.registerUser=function(){var registrationModalOptions={templateUrl:"views/modals/6cdc3338.6cdc3338.manualRegistration.html",controller:"registrationModal",resolve:{conference:function(){return conference}}};$modal.open(registrationModalOptions)},$scope.allowDeleteRegistration=function(){return permissions.permissionInt>1},$scope.getRegistration=function(id){return _.find(registrations,{id:id})},$scope.getRegistrantType=function(id){return _.find(conference.registrantTypes,{id:id})},$scope.withdrawRegistrant=function(registrant,value){registrant.withdrawn=value,value&&(registrant.withdrawnTimestamp=new Date),$http.put("registrations/"+registrant.registrationId,$scope.getRegistration(registrant.registrationId)).error(function(){registrant.withdrawn=!value,alert("An error occurred while updating this registration.")})},$scope.deleteRegistrant=function(registrant){var modalInstance=$modal.open({templateUrl:"views/modals/7d123415.7d123415.deleteRegistration.html",controller:"deleteRegistrationCtrl"});modalInstance.result.then(function(doDelete){if(doDelete){var registration=_.find(registrations,{id:registrant.registrationId}),url="registrations/"+registration.id;registration.registrants.length>1&&(url="registrants/"+registrant.id),$http({method:"DELETE",url:url}).success(function(){_.remove($scope.registrants,function(r){return r.id===registrant.id}),_.remove(registration.registrants,function(r){return r.id===registrant.id})})}})}}),angular.module("confRegistrationWebApp").controller("exportDataModal",function($scope,$modalInstance,$cookies,conference,apiUrl,hasCost){$scope.conference=conference,$scope.apiUrl=apiUrl,$scope.authToken=$cookies.crsToken,$scope.hasCost=hasCost,$scope.close=function(){$modalInstance.close("")}}),angular.module("confRegistrationWebApp").controller("genericModal",function($scope,$modalInstance,data){$scope.isArray=_.isArray(data),$scope.data=data,$scope.close=function(){$modalInstance.close("")}}),angular.module("confRegistrationWebApp").controller("landingCtrl",function($rootScope){$rootScope.globalPage={type:"landing",mainClass:"container dashboard",bodyClass:"",title:"",confId:0,footer:!0}}),angular.module("confRegistrationWebApp").controller("LoginDialogCtrl",function($rootScope,$scope,apiUrl){$rootScope.globalPage={type:"","class":"",title:"",confId:0,footer:!1},$scope.apiUrl=apiUrl}),angular.module("confRegistrationWebApp").controller("PaymentApprovalCtrl",function($scope,$rootScope,$routeParams,$http){$rootScope.globalPage={type:"registration",mainClass:"container front-form",bodyClass:"frontend",title:"Event Registration Tool",confId:0,footer:!1},$scope.payment={};var paymentHash=$routeParams.paymentHash;$http.get("payments/scholarship/"+paymentHash).success(function(data){$scope.payment=data}).error(function(){$scope.payment=null}),$scope.updatePayment=function(status){$scope.posting=!0;var paymentObject=angular.copy($scope.payment);paymentObject.scholarship.scholarshipStatus=status,$http.put("payments/scholarship/"+paymentHash,paymentObject).success(function(){$scope.payment=paymentObject}).error(function(){alert("An error occurred while saving the payment."),$scope.posting=!1})}}),angular.module("confRegistrationWebApp").controller("paymentModal",function($scope,$modalInstance,$http,registration,conference){$scope.registration=registration,$scope.conference=conference,$scope.currentYear=(new Date).getFullYear(),$scope.processing=!1,$scope.close=function(){$modalInstance.close($scope.registration)},$scope.getRegistrantType=function(id){return _.find(conference.registrantTypes,{id:id})},$scope.getBlock=function(blockId){var allBlocks=[];return _.each(conference.registrationPages,function(page){allBlocks=allBlocks.concat(page.blocks)}),_.find(allBlocks,{id:blockId})},$scope.newTransaction={registrationId:registration.id,amount:registration.remainingBalance},$scope.updateCostRegistration=[],angular.forEach(registration.registrants,function(r){$scope.updateCostRegistration[r.id]=r.calculatedTotalDue}),$scope.processTransaction=function(){if(_.isEmpty($scope.newTransaction.paymentType))return void alert("Please select a transaction type.");if(Number($scope.newTransaction.amount)<=0)return void alert("Transaction amount must be a positive number.");$scope.processing=!0;var path="payments";"ADDITIONAL_EXPENSE"===$scope.newTransaction.paymentType?(path="expenses",delete $scope.newTransaction.paymentType):$scope.newTransaction.readyToProcess=!0,$http.post(path,$scope.newTransaction).success(function(){loadPayments()}).error(function(){alert("Transaction failed..."),$scope.processing=!1})},$scope.canBeRefunded=function(payment){return"CREDIT_CARD_REFUND"!==payment.paymentType&&"REFUND"!==payment.paymentType&&$scope.calculateRefundableAmount(payment)>0},$scope.calculateRefundableAmount=function(payment){if(angular.isUndefined(payment))return 0;var sum=payment.amount;return _.each($scope.registration.pastPayments,function(prevRefund){"CREDIT_CARD_REFUND"!==prevRefund.paymentType&&"REFUND"!==prevRefund.paymentType||prevRefund.refundedPaymentId!==payment.id||(sum-=prevRefund.amount)}),sum},$scope.isCreditCardPayment=function(){return $scope.paymentToRefund&&"CREDIT_CARD"===$scope.paymentToRefund.paymentType},$scope.startRefund=function(payment){$scope.paymentToRefund=payment,$scope.refund=$scope.isCreditCardPayment()?{amount:$scope.calculateRefundableAmount(payment),refundedPaymentId:payment.id,registrationId:payment.registrationId,paymentType:"CREDIT_CARD_REFUND",creditCard:{lastFourDigits:payment.creditCard.lastFourDigits},readyToProcess:!0}:{amount:$scope.calculateRefundableAmount(payment),refundedPaymentId:payment.id,registrationId:payment.registrationId,paymentType:"REFUND",readyToProcess:!0}},$scope.processRefund=function(){$scope.processing=!0,$http.post("payments/",$scope.refund).success(function(){$http.get("registrations/"+$scope.registration.id).success(function(data){$scope.registration=data,$scope.processing=!1,$scope.refund=null,angular.isDefined($scope.newTransaction)&&($scope.newTransaction.amount=data.remainingBalance)})}).error(function(){alert("Refund failed..."),$scope.processing=!1})},$scope.cancelRefund=function(){delete $scope.refund},$scope.removeExpense=function(expense){$http["delete"]("expenses/"+expense.id).success(function(){$http.get("registrations/"+$scope.registration.id).success(function(data){$scope.registration=data})}).error(function(){alert("Error removing expense.")})},$scope.saveEdits=function(payment){$http.put("payments/"+payment.id,payment).success(function(){loadPayments()})},$scope.openEditPaymentRow=function(payment){angular.isDefined($scope.editPayment)?delete $scope.editPayment:$scope.editPayment=angular.copy(payment)};var loadPayments=function(){$http.get("registrations/"+$scope.registration.id).success(function(data){$scope.registration=data,$scope.processing=!1,$scope.newTransaction={registrationId:registration.id,amount:data.remainingBalance}})};$scope.deletePayment=function(payment){window.confirm("Do you really want to delete this payment?")&&$http["delete"]("payments/"+payment.id,payment).success(function(){loadPayments()})}}),angular.module("confRegistrationWebApp").controller("RegistrationCtrl",function($scope,$rootScope,$sce,$routeParams,$location,$window,RegistrationCache,conference,currentRegistration,validateRegistrant){function getPageAfterById(pageId){for(var pages=$scope.conference.registrationPages,i=0;i<pages.length;i++)if(angular.equals(pageId,pages[i].id))return pages[i+1]}$rootScope.globalPage={type:"registration",mainClass:"container front-form",bodyClass:"frontend",title:conference.name,confId:conference.id,footer:!1};var pageId=$routeParams.pageId;if(angular.isUndefined(pageId)&&currentRegistration.completed&&$location.path("reviewRegistration/"+conference.id),$scope.validPages={},$scope.$on("pageValid",function(event,validity){event.stopPropagation(),$scope.validPages[event.targetScope.page.id]=validity,$scope.registrationComplete=_.filter($scope.validPages).length===$scope.conference.registrationPages.length}),$scope.conference=angular.copy(conference),$scope.currentRegistration=currentRegistration,$scope.currentRegistrant=$routeParams.reg,angular.isDefined($routeParams.reg)){var reg=_.find(currentRegistration.registrants,{id:$routeParams.reg});if(angular.isUndefined(reg))return void $location.path($rootScope.registerMode+"/"+$scope.conference.id+"/page/").search("reg",null);angular.forEach(angular.copy(conference.registrationPages),function(page){var pageIndex=_.findIndex($scope.conference.registrationPages,{id:page.id});angular.forEach(angular.copy(page.blocks),function(block){_.contains(block.registrantTypes,reg.registrantTypeId)&&_.remove($scope.conference.registrationPages[pageIndex].blocks,function(b){return b.id===block.id})}),0===$scope.conference.registrationPages[pageIndex].blocks.length&&_.remove($scope.conference.registrationPages,function(p){return p.id===page.id})})}$scope.activePageId=pageId||"",$scope.page=_.find(conference.registrationPages,{id:pageId}),$scope.activePageIndex=_.findIndex($scope.conference.registrationPages,{id:pageId}),$scope.nextPage=getPageAfterById(pageId),-1===$scope.activePageIndex&&angular.isDefined($scope.page)&&$location.path("/"+$rootScope.registerMode+"/"+conference.id+"/page/"+$scope.conference.registrationPages[0].id),$scope.validateAndGoToNext=function(isValid){isValid?angular.isDefined($scope.nextPage)?$location.path("/"+$rootScope.registerMode+"/"+conference.id+"/page/"+$scope.nextPage.id):$location.path("/reviewRegistration/"+conference.id).search("regType",null):($window.scrollTo(0,0),$scope.notify={"class":"alert-danger",message:$sce.trustAsHtml("Please fill in all required fields.")})},$scope.previousPage=function(){var previousPage=$scope.conference.registrationPages[$scope.activePageIndex-1];$location.path(angular.isDefined(previousPage)?"/"+$rootScope.registerMode+"/"+conference.id+"/page/"+previousPage.id:$scope.currentRegistration.completed?"/reviewRegistration/"+conference.id:"/"+$rootScope.registerMode+"/"+conference.id+"/page/")},$scope.registrantName=function(r){var returnStr,nameBlock=_.find(_.flatten(conference.registrationPages,"blocks"),{profileType:"NAME"}).id,registrant=_.find(currentRegistration.registrants,{id:r.id});return nameBlock=_.find(registrant.answers,{blockId:nameBlock}),angular.isDefined(nameBlock)&&(nameBlock=nameBlock.value,angular.isDefined(nameBlock.firstName)&&(returnStr=nameBlock.firstName+" "+(nameBlock.lastName||""))),returnStr||_.find(conference.registrantTypes,{id:r.registrantTypeId}).name},$scope.registrantIsComplete=function(registrantId){var invalidBlocks=validateRegistrant.validate(conference,_.find(currentRegistration.registrants,{id:registrantId}));return 0===invalidBlocks.length},$scope.anyPaymentMethodAccepted=function(){return conference.acceptCreditCards||conference.acceptChecks||conference.acceptTransfers||conference.acceptScholarships}}),angular.module("confRegistrationWebApp").controller("registrationModal",function($scope,$modalInstance,$http,$route,conference,uuid,RegistrationCache){$scope.conference=conference,$scope.form={type:_.first(conference.registrantTypes).id},$scope.register=function(){var registrationId=uuid(),registration={id:registrationId,conferenceId:conference.id,completed:!0,registrants:[{id:uuid(),registrantTypeId:$scope.form.type,registrationId:registrationId,answers:[]}]};angular.forEach(_.flatten(conference.registrationPages,"blocks"),function(block){if("EMAIL"===block.profileType||"NAME"===block.profileType){var answer={id:uuid(),registrantId:registration.id,blockId:block.id};"EMAIL"===block.profileType?answer.value=$scope.form.email:"NAME"===block.profileType&&(answer.value={firstName:$scope.form.first,lastName:$scope.form.last}),registration.registrants[0].answers.push(answer)}}),$http.post("conferences/"+conference.id+"/registrations",registration,{headers:{"Registration-Type":"on-behalf-of"}}).success(function(){RegistrationCache.emptyCache(),$route.reload()}).error(function(data){console.log("Error: "+data)}),$modalInstance.close()},$scope.close=function(){$modalInstance.close()}}),angular.module("confRegistrationWebApp").controller("ReviewRegistrationCtrl",function($scope,$rootScope,$location,$route,$modal,$http,registration,conference,RegistrationCache,validateRegistrant,$filter){if($rootScope.globalPage={type:"registration",mainClass:"container front-form",bodyClass:"frontend",title:conference.name,confId:conference.id,footer:!1},_.isEmpty(registration.registrants)&&$location.path("/"+($rootScope.registerMode||"register")+"/"+conference.id+"/page/"),$scope.conference=conference,$scope.currentRegistration=registration,$scope.blocks=[],$scope.regValidate=[],_.isEmpty(registration.registrants)||($scope.allowGroupRegistration=!1,angular.forEach(registration.registrants,function(r){if(!$scope.allowGroupRegistration){var regType=_.find(conference.registrantTypes,{id:r.registrantTypeId});$scope.allowGroupRegistration=regType.allowGroupRegistrations}})),angular.isUndefined($scope.currentPayment)){var paymentType;conference.acceptCreditCards?paymentType="CREDIT_CARD":conference.acceptChecks?paymentType="CHECK":conference.acceptTransfers?paymentType="TRANSFER":conference.acceptScholarships&&(paymentType="SCHOLARSHIP"),$scope.currentPayment={amount:$scope.currentRegistration.remainingBalance,paymentType:paymentType,creditCard:{},transfer:{},scholarship:{}}}angular.forEach(_.flatten(conference.registrationPages,"blocks"),function(block){-1===block.type.indexOf("Content")&&$scope.blocks.push(block)}),angular.forEach(registration.registrants,function(r){$scope.regValidate[r.id]=validateRegistrant.validate(conference,r)}),$scope.findAnswer=function(blockId){return _.find($scope.answers,{blockId:blockId})},$scope.getBlock=function(blockId){return _.find($scope.blocks,{id:blockId})},$scope.confirmRegistration=function(){if($scope.submittingRegistration=!0,$scope.currentRegistration.totalPaid<$scope.currentRegistration.calculatedMinimumDeposit&&$scope.currentPayment.amount+$scope.currentRegistration.totalPaid<$scope.currentRegistration.calculatedMinimumDeposit&&$scope.currentPayment.errors.push("You are required to pay at least the minimum deposit of "+$filter("moneyFormat")(registration.calculatedMinimumDeposit)+" to register for this event."),$scope.currentPayment.amount>$scope.currentRegistration.remainingBalance&&$scope.currentPayment.errors.push("You are paying more than the total due of "+$filter("moneyFormat")(registration.remainingBalance)+" to register for this event."),0===$scope.currentPayment.amount||!$scope.anyPaymentMethodAccepted())return void setRegistrationAsCompleted();if(!_.isEmpty($scope.currentPayment.errors))return $modal.open({templateUrl:"views/modals/3d754af3.3d754af3.errorModal.html",controller:"genericModal",resolve:{data:function(){return $scope.currentPayment.errors}}}),void($scope.submittingRegistration=!1);if("CHECK"===$scope.currentPayment.paymentType)return void($scope.currentRegistration.completed?$scope.submittingRegistration=!1:setRegistrationAsCompleted());var currentPayment=angular.copy($scope.currentPayment);currentPayment.readyToProcess=!0,currentPayment.registrationId=registration.id,delete currentPayment.errors,$http.post("payments/",currentPayment).success(function(){delete $scope.currentPayment,$scope.currentRegistration.completed?(window.scrollTo(0,0),$route.reload()):setRegistrationAsCompleted()}).error(function(){$scope.submittingRegistration=!1,$modal.open({templateUrl:"views/modals/3d754af3.3d754af3.errorModal.html",controller:"genericModal",backdrop:"static",keyboard:!1,resolve:{data:function(){return"Your payment was declined, please verify your details or use a different payment method."}}})})};var setRegistrationAsCompleted=function(){window.scrollTo(0,0),registration.completed=!0,RegistrationCache.update("registrations/"+registration.id,registration,function(){RegistrationCache.emptyCache(),$route.reload()},function(){$scope.currentRegistration.completed=!1,$scope.submittingRegistration=!1,alert("An error occurred while submitting your registration.")})};$scope.editRegistrant=function(id){$location.path("/"+($rootScope.registerMode||"register")+"/"+conference.id+"/page/"+conference.registrationPages[0].id).search("reg",id)},$scope.removeRegistrant=function(id){confirm("Are you sure you want to delete this registrant?")&&(_.remove($scope.currentRegistration.registrants,function(r){return r.id===id}),RegistrationCache.update("registrations/"+$scope.currentRegistration.id,$scope.currentRegistration,function(){$route.reload()}))},$scope.getRegistrantType=function(id){return _.find(conference.registrantTypes,{id:id})},$scope.isBlockInvalid=function(rId,bId){return _.contains($scope.regValidate[rId],bId)},$scope.allRegistrantsValid=function(){var returnVal=!0;return angular.forEach(registration.registrants,function(r){angular.isUndefined($scope.regValidate[r.id])?returnVal=!1:$scope.regValidate[r.id].length&&(returnVal=!1)}),returnVal},$scope.blockInRegType=function(block,regTypeId){return!_.contains(block.registrantTypes,regTypeId)},$scope.anyPaymentMethodAccepted=function(){return conference.acceptCreditCards||conference.acceptChecks||conference.acceptTransfers||conference.acceptScholarships},$scope.registrantDeletable=function(r){if(registration.completed)return!1;var groupRegistrants=0,noGroupRegistrants=0;angular.forEach(registration.registrants,function(r){var regType=_.find(conference.registrantTypes,{id:r.registrantTypeId});regType.allowGroupRegistrations?groupRegistrants++:noGroupRegistrants++});var regType=_.find(conference.registrantTypes,{id:r.registrantTypeId});return regType.allowGroupRegistrations&&1===groupRegistrants&&noGroupRegistrants?!1:!0}}),angular.module("confRegistrationWebApp").directive("adminNav",function($http,ConfCache){return{templateUrl:"views/components/f109ba5c.f109ba5c.adminNav.html",restrict:"A",controller:function($scope,$modal,$location){$scope.archiveEvent=function(conferenceId){$modal.open({templateUrl:"views/modals/2bd8bdd4.2bd8bdd4.archiveEvent.html",controller:"confirmCtrl"}).result.then(function(result){result&&ConfCache.getCallback(conferenceId,function(conference){conference.archived=!0,$http({method:"PUT",url:"conferences/"+conferenceId,data:conference}).success(function(){ConfCache.empty(),$location.path("/eventDashboard")}).error(function(data){alert("Error: "+data)})})})}}}}),angular.module("confRegistrationWebApp").directive("crsBlock",function(){return{templateUrl:"views/components/0406f620.0406f620.blockDirective.html",restrict:"A",controller:function($scope,$routeParams,$modal,AnswerCache,RegistrationCache,uuid){if(_.contains(["checkboxQuestion","radioQuestion","selectQuestion"],$scope.block.type)&&angular.isDefined($scope.block.content.choices)&&$scope.block.content.choices.length&&angular.isUndefined(_.first($scope.block.content.choices).value)&&angular.forEach($scope.block.content.choices,function(c,i){$scope.block.content.choices[i]={value:c,desc:""}}),!$scope.wizard)if(angular.isDefined($scope.adminEditRegistration)){var answerForThisBlock=_.where($scope.adminEditRegistration.answers,{blockId:$scope.block.id});answerForThisBlock.length>0&&($scope.answer=answerForThisBlock[0]),angular.isUndefined($scope.answer)&&($scope.answer={id:uuid(),registrantId:$scope.adminEditRegistration.id,blockId:$scope.block.id,value:"checkboxQuestion"===$scope.block.type?{}:""},$scope.adminEditRegistration.answers.push($scope.answer))}else RegistrationCache.getCurrent($scope.conference.id).then(function(currentRegistration){var registrantId=$routeParams.reg;if(!angular.isUndefined(registrantId)&&!angular.isUndefined($scope.block)){var registrantIndex=_.findIndex(currentRegistration.registrants,{id:registrantId});if(-1!==registrantIndex){var answerForThisBlock=_.where(currentRegistration.registrants[registrantIndex].answers,{blockId:$scope.block.id});answerForThisBlock.length>0&&($scope.answer=answerForThisBlock[0]),angular.isUndefined($scope.answer)&&($scope.answer={id:uuid(),registrantId:registrantId,blockId:$scope.block.id,value:"checkboxQuestion"===$scope.block.type?{}:""},currentRegistration.registrants[registrantIndex].answers.push($scope.answer))}}}),AnswerCache.syncBlock($scope,"answer");if($scope.editBlockAddOption=function(newOption){angular.isUndefined($scope.block.content.choices)&&($scope.block.content={choices:[]}),$scope.block.content.choices.push({value:newOption,desc:""})},$scope.editBlockOptionMoveUp=function(index){if(index>0&&index<$scope.block.content.choices.length){var temp=$scope.block.content.choices[index];$scope.block.content.choices[index]=$scope.block.content.choices[index-1],$scope.block.content.choices[index-1]=temp}},$scope.editBlockOptionMoveDown=function(index){if(index>=0&&index<$scope.block.content.choices.length-1){var temp=$scope.block.content.choices[index];$scope.block.content.choices[index]=$scope.block.content.choices[index+1],$scope.block.content.choices[index+1]=temp}},$scope.editBlockDeleteOption=function(index){$scope.block.content.choices.splice(index,1)},$scope.editBlockOptionAdvanced=function(index){$modal.open({templateUrl:"views/modals/3e80e264.3e80e264.choiceOptions.html",controller:function($scope,$modalInstance,choice,blockType){$scope.blockType=blockType,$scope.choice=choice,$scope.close=function(){$modalInstance.dismiss()},$scope.save=function(choice){choice.amount=choice.amount.replace(",",""),_.isNaN(Number(choice.amount))?alert("Error: please enter a valid additional cost."):$modalInstance.close(choice)}},resolve:{choice:function(){return angular.copy($scope.block.content.choices[index])},blockType:function(){return $scope.block.type}}}).result.then(function(choice){choice.amount=Number(choice.amount),$scope.block.content.choices[index]=choice})},$scope.wizard){$scope.activeTab="options",$scope.visibleRegTypes={},angular.forEach($scope.conference.registrantTypes,function(type){$scope.visibleRegTypes[type.id]=!_.contains($scope.block.registrantTypes,type.id)}),$scope.$watch("visibleRegTypes",function(object){angular.isDefined(object)&&($scope.block.registrantTypes=[],angular.forEach(object,function(v,k){v||$scope.block.registrantTypes.push(k)}))},!0);var typeToProfile=[];typeToProfile.phoneQuestion="PHONE",typeToProfile.addressQuestion="ADDRESS",typeToProfile.genderQuestion="GENDER",typeToProfile.yearInSchoolQuestion="YEAR_IN_SCHOOL",$scope.profileCheck=!_.isNull($scope.block.profileType),$scope.profileOption=_.has(typeToProfile,$scope.block.type),$scope.requiredOption=!_.contains(["paragraphContent"],$scope.block.type),$scope.canDelete=!_.contains(["NAME","EMAIL"],$scope.block.profileType),$scope.hasOptions=_.contains(["radioQuestion","checkboxQuestion","selectQuestion"],$scope.block.type)}$scope.toggleProfileType=function(value){if(value){$scope.block.profileType=typeToProfile[$scope.block.type];var profileCount=0;$scope.conference.registrationPages.forEach(function(page){page.blocks.forEach(function(block){$scope.block.profileType===block.profileType&&profileCount++})}),profileCount>1&&(alert("Only one "+$scope.block.profileType.charAt(0).toUpperCase()+$scope.block.profileType.slice(1).toLowerCase()+" profile block can be used per form."),$scope.block.profileType=null,$scope.profileCheck=!1)}else $scope.block.profileType=null}}}}),angular.module("confRegistrationWebApp").directive("nameQuestion",function(){return{templateUrl:"views/blocks/14ffec39.14ffec39.nameQuestion.html",restrict:"E"}}),angular.module("confRegistrationWebApp").directive("addressQuestion",function(){return{templateUrl:"views/blocks/b2397891.b2397891.addressQuestion.html",restrict:"E"}}),angular.module("confRegistrationWebApp").directive("checkboxQuestion",function(){return{templateUrl:"views/blocks/b2244960.b2244960.checkboxQuestion.html",restrict:"E",controller:function($scope){$scope.wizard?$scope.answer={value:{}}:$scope.$watch("answer.value",function(){angular.isDefined($scope.answer)&&($scope.atLeastOneChecked=angular.isDefined(_.findKey($scope.answer.value,function(v){return v===!0}))?!0:!1)},!0)}}}),angular.module("confRegistrationWebApp").directive("emailQuestion",function(){return{templateUrl:"views/blocks/fc2641f1.fc2641f1.emailQuestion.html",restrict:"E"}}),angular.module("confRegistrationWebApp").directive("numberQuestion",function(){return{templateUrl:"views/blocks/9ce130c5.9ce130c5.numberQuestion.html",restrict:"E"}}),angular.module("confRegistrationWebApp").directive("phoneQuestion",function(){return{templateUrl:"views/blocks/639a1566.639a1566.phoneQuestion.html",restrict:"E"}}),angular.module("confRegistrationWebApp").directive("radioQuestion",function(){return{templateUrl:"views/blocks/85e5033a.85e5033a.radioQuestion.html",restrict:"E"}}),angular.module("confRegistrationWebApp").directive("selectQuestion",function(){return{templateUrl:"views/blocks/31bebbeb.31bebbeb.selectQuestion.html",restrict:"E",controller:function($scope,$filter){$scope.$watch("block",function(){$scope.visibleValues=[],angular.forEach($scope.block.content.choices,function(c){var visibleValue=c.value;c.amount&&(visibleValue=visibleValue+" - "+$filter("moneyFormat")(c.amount)),$scope.visibleValues.push(visibleValue)})},!0)}}}),angular.module("confRegistrationWebApp").directive("textQuestion",function(){return{templateUrl:"views/blocks/db6fdda7.db6fdda7.textQuestion.html",restrict:"E"}}),angular.module("confRegistrationWebApp").directive("genderQuestion",function(){return{templateUrl:"views/blocks/3fdb1ded.3fdb1ded.genderQuestion.html",restrict:"E"}}),angular.module("confRegistrationWebApp").directive("dateQuestion",function(){return{templateUrl:"views/blocks/1d6423d9.1d6423d9.dateQuestion.html",restrict:"E"}}),angular.module("confRegistrationWebApp").directive("yearInSchoolQuestion",function(){return{templateUrl:"views/blocks/79c4b7cd.79c4b7cd.yearInSchoolQuestion.html",restrict:"E"}}),angular.module("confRegistrationWebApp").directive("textareaQuestion",function(){return{templateUrl:"views/blocks/5a8007f2.5a8007f2.textareaQuestion.html",restrict:"E"}}),angular.module("confRegistrationWebApp").directive("crsDatetimepicker",function(){return{templateUrl:"views/components/5bf70d48.5bf70d48.datepicker.html",restrict:"E",scope:{localModel:"=model"},controller:function($timeout,$scope){$scope.updateTimeStamp=function(timestamp){$scope.$apply(function(){$scope.localModel=moment(timestamp).format("YYYY-MM-DD HH:mm:ss")})}},link:function(scope,element){var datePickerElement=jQuery(element).find(".datepicker");datePickerElement.datetimepicker({defaultDate:moment(scope.localModel).format("MM/DD/YYYY hh:mm A")}).on("dp.change",function(ev){scope.updateTimeStamp(ev.date)}),scope.$on("$destroy",function(){angular.isDefined(datePickerElement.data("DateTimePicker"))&&datePickerElement.data("DateTimePicker").destroy()})}}}),angular.module("confRegistrationWebApp").directive("formElements",function(){return{restrict:"A",link:function(scope){var newDragBlock="";window.setTimeout(function(){jQuery(".connectedSortable").sortable({connectWith:".connectedSortable",stop:function(event,ui){""!==newDragBlock?(scope.insertBlock(newDragBlock,ui.item.parent().attr("id"),ui.item.index(),ui.item.attr("default-title"),ui.item.attr("default-profile")),ui.item.remove()):(scope.moveBlock(ui.item.find(".crsQuestion").attr("id"),ui.item.parent().attr("id"),ui.item.index()),ui.item.remove(),scope.$apply())}}),jQuery(".page-form").sortable({stop:function(event,ui){scope.movePage(ui.item.attr("data-page-id"),ui.item.index())}}),jQuery(".crsFormElements li").draggable({connectToSortable:".connectedSortable",helper:"clone",revert:"invalid",start:function(){newDragBlock=$(this).attr("id")},stop:function(){newDragBlock="",formElementsScroll()}}).disableSelection();var formElementsScroll=function(){var yOffset=jQuery(window).scrollTop(),elementlist=jQuery(".waypoint1").offset().top,windowHeight=jQuery(window).height(),crsFormElementsHeight=jQuery(".elements-list").height()+60,footerHeight=0,remainingDocToScroll=jQuery(document).height()-(yOffset+jQuery(window).height())-footerHeight;yOffset-elementlist>0&&windowHeight+remainingDocToScroll>crsFormElementsHeight&&windowHeight>crsFormElementsHeight?(jQuery(".elements-list, .functions-header").css("position","fixed"),jQuery(".form-page").css("margin-top",jQuery(".functions-header").css("height"))):(jQuery(".elements-list, .functions-header").css("position","relative"),jQuery(".form-page").css("margin-top","0"))};jQuery(window).scroll(function(){return jQuery(".waypoint1").length?void formElementsScroll():void jQuery(window).unbind("scroll")}),jQuery(window).resize(function(){return jQuery(".waypoint1").length?void formElementsScroll():void jQuery(window).unbind("resize")})},500)}}}),angular.module("confRegistrationWebApp").directive("ngEnter",function(){return function(scope,element,attrs){element.bind("keypress",function(event){13===event.which&&(scope.$apply(function(){scope.$eval(attrs.ngEnter)}),event.preventDefault())})}}),angular.module("confRegistrationWebApp").directive("page",function(){return{templateUrl:"views/components/002a1bad.002a1bad.pageDirective.html",restrict:"E",controller:function($scope,$location){$scope.wizard=-1!==$location.path().indexOf("eventForm"),$scope.$watch("pageForm.$valid",function(valid){$scope.$emit("pageValid",valid)})}}}),angular.module("confRegistrationWebApp").directive("ertPayment",function(){return{templateUrl:"views/components/bd117521.bd117521.payment.html",restrict:"A",scope:{currentPayment:"=payment",currentRegistration:"=registration"},controller:function($scope,$http){$scope.conference=$scope.$parent.conference,$scope.currentYear=(new Date).getFullYear(),$scope.paymentMethodsViews={CREDIT_CARD:"views/paymentMethods/27fff8f8.27fff8f8.creditCard.html",CHECK:"views/paymentMethods/afb7661f.afb7661f.check.html",TRANSFER:"views/paymentMethods/8ebfe730.8ebfe730.transfer.html",SCHOLARSHIP:"views/paymentMethods/6995a898.6995a898.scholarship.html"},$scope.searchStaff=function(val){return $http.get("staffsearch/"+encodeURIComponent(val)).then(function(response){return response.data
})},$scope.selectStaff=function(item){$scope.currentPayment.scholarship={staffApprovalName:item.firstName+" "+item.lastName,staffEmail:item.email}},$scope.$watch("currentPayment",function(currentPayment){if(!angular.isUndefined(currentPayment)){var paymentErrors=[];"CREDIT_CARD"===currentPayment.paymentType?(currentPayment.creditCard.nameOnCard||paymentErrors.push("Please enter the name on your card."),currentPayment.creditCard.number||paymentErrors.push("Please enter your card number."),currentPayment.creditCard.expirationMonth&&currentPayment.creditCard.expirationYear||paymentErrors.push("Please enter your card expiration date."),currentPayment.creditCard.cvvNumber||paymentErrors.push("Please enter your card cvv."),currentPayment.creditCard.billingAddress&&currentPayment.creditCard.billingCity&&currentPayment.creditCard.billingZip||paymentErrors.push("Please enter your card billing details.")):"TRANSFER"===currentPayment.paymentType?currentPayment.transfer.source||paymentErrors.push("Please enter a Chart Field or Account Number."):"SCHOLARSHIP"===currentPayment.paymentType&&(currentPayment.scholarship.staffEmail||paymentErrors.push("Please select a staff member to approve your scholarship.")),$scope.currentPayment.errors=_.isEmpty(paymentErrors)?[]:paymentErrors}},!0)}}}),angular.module("confRegistrationWebApp").directive("registrationTypeSelect",function(){return{templateUrl:"views/components/6930639d.6930639d.registrationTypeSelect.html",restrict:"E",controller:function($scope,$rootScope,$location,$routeParams,RegistrationCache,uuid){$scope.visibleRegistrantTypes=angular.copy($scope.conference.registrantTypes);var visibleType=$routeParams.regType;angular.isDefined(visibleType)?_.remove($scope.visibleRegistrantTypes,function(t){return t.id!==visibleType}):(_.remove($scope.visibleRegistrantTypes,function(t){return t.hidden}),_.isEmpty($scope.currentRegistration.registrants)&&_.remove($scope.visibleRegistrantTypes,function(t){return t.groupSubRegistrantType})),$scope.newRegistrant=function(type){var newId=uuid();$scope.currentRegistration.registrants.push({id:newId,registrationId:$scope.currentRegistration.id,registrantTypeId:type,answers:[]}),RegistrationCache.update("registrations/"+$scope.currentRegistration.id,$scope.currentRegistration,function(){RegistrationCache.emptyCache(),$location.path(($rootScope.registerMode||"register")+"/"+$scope.conference.id+"/page/"+$scope.conference.registrationPages[0].id).search("reg",newId)})},$scope.isConferenceCost=function(){return _.max(_.flatten($scope.conference.registrantTypes,"cost"))>0}}}}),angular.module("confRegistrationWebApp").directive("selectOnClick",function(){return{restrict:"A",link:function(scope,element,attrs){element.on("click",function(){var elementToSelect=attrs.selectOnClick;_.isEmpty(elementToSelect)?this.select():document.getElementById(elementToSelect).select()})}}}),angular.module("confRegistrationWebApp").directive("showAnswer",function(){return{templateUrl:"views/components/1ecaa30d.1ecaa30d.answerDisplay.html",restrict:"E",scope:{block:"=",registrant:"=",showAmount:"="},controller:function($scope){if(angular.isDefined($scope.registrant)&&$scope.registrant.answers){var answerObject=_.find($scope.registrant.answers,{blockId:$scope.block.id});answerObject&&($scope.answer=answerObject)}$scope.getSelectedCheckboxes=function(choices){return _.keys(_.pick(choices,function(val){return val===!0}))}}}}),angular.module("confRegistrationWebApp").filter("evtDateFormat",function(){return function(date,zone){return moment.tz(date,zone).format("MMM D, YYYY h:mm a z")}}),angular.module("confRegistrationWebApp").filter("joiner",function(){return function(input,separator){return angular.isArray(input)?input.join(separator||", "):input}}),angular.module("confRegistrationWebApp").filter("moneyFormat",function(){return function(num){return angular.isUndefined(num)||_.isNull(num)?"":"$"+num.toFixed(2).replace(/\d(?=(\d{3})+\.)/g,"$&,")}}),angular.module("confRegistrationWebApp").filter("paymentTypeFormat",function(){return function(paymentType){return angular.isUndefined(paymentType)?"":paymentType.charAt(0).toUpperCase()+paymentType.substring(1).toLowerCase()}}),angular.module("confRegistrationWebApp").filter("tel",function(){return function(tel){if(!tel)return"";var country,city,number,value=tel.toString().trim().replace(/\D/g,"");switch(value.length){case 10:country=1,city=value.slice(0,3),number=value.slice(3);break;case 11:country=value[0],city=value.slice(1,4),number=value.slice(4);break;case 12:country=value.slice(0,3),city=value.slice(3,5),number=value.slice(5);break;default:return value}return 1===country&&(country=""),number=number.slice(0,3)+"-"+number.slice(3),(country+" ("+city+") "+number).trim()}}),angular.module("confRegistrationWebApp").service("AnswerCache",function($cacheFactory,$rootScope,$http,$q){var cache=$cacheFactory("answers"),blockIndex=$cacheFactory("blockIndex"),path=function(id){return"answers/"+(id||"")},update=function(path,object){updateServer(object),cache.put(path,object),blockIndex.put(object.block,object),$rootScope.$broadcast(path,object)},updateServer=function(answer){"preview"!==$rootScope.registerMode&&$http.put(path(answer.id),answer)},checkCache=function(path,callback){var cachedObject=cache.get(path);angular.isDefined(cachedObject)?callback(cachedObject,path):$http.get(path).success(function(conferences){cache.put(path,conferences),callback(conferences,path)})};this.query=function(id){checkCache(path(id),function(conferences,path){$rootScope.$broadcast(path,conferences)})},this.get=function(id){var defer=$q.defer();return checkCache(path(id),function(conferences){defer.resolve(conferences)}),defer.promise},this.put=function(answer){cache.put(path(answer.id),answer)},this.syncBlock=function(scope,name){scope.$watch(name,function(answer,oldAnswer){angular.isUndefined(answer)||angular.isUndefined(oldAnswer)||angular.equals(answer,oldAnswer)||update(path(answer.id),answer)},!0)}}),angular.module("confRegistrationWebApp").factory("apiUrl",function($location,$rootScope){var host=$location.$$host;return _.contains(["localhost","stage.eventregistrationtool.com"],host)?($rootScope.environment="staging","https://api.stage.eventregistrationtool.com/eventhub-api/rest/"):($rootScope.environment="production","https://api.eventregistrationtool.com/eventhub-api/rest/")}),angular.module("confRegistrationWebApp").factory("authorizationInterceptor",function($cookies){return{request:function(config){return config.headers.PreviousAuthorization=$cookies.crsPreviousToken,config.headers.Authorization=$cookies.crsToken,config.withCredentials=!0,config}}}),angular.module("confRegistrationWebApp").service("ConfCache",function($cacheFactory,$rootScope,$http,$q,uuid){var cache=$cacheFactory("conf"),path=function(id){return"conferences/"+(id||"")},checkCache=function(path,callback){var cachedConferences=cache.get(path);angular.isDefined(cachedConferences)?callback(cachedConferences,path):$http.get(path).success(function(conferences){cache.put(path,conferences),callback(conferences,path)})};this.query=function(id){checkCache(path(id),function(conferences,path){$rootScope.$broadcast(path,conferences)})},this.get=function(id){var defer=$q.defer();return checkCache(path(id),function(conferences){defer.resolve(conferences)}),defer.promise},this.getCallback=function(id,callback){checkCache(path(id),function(conferences){callback(conferences)})},this.update=function(id,conference){cache.put(path(id),conference)},this.empty=function(){cache.removeAll()},this.create=function(name){var newConferenceId=uuid(),newPageId=uuid(),data={id:newConferenceId,name:name,allowEditRegistrationAfterComplete:!0,registrationStartTime:moment().format("YYYY-MM-DD HH:mm:ss"),registrationEndTime:moment().add(14,"days").format("YYYY-MM-DD HH:mm:ss"),eventStartTime:moment().add(14,"days").format("YYYY-MM-DD HH:mm:ss"),eventEndTime:moment().add(20,"days").format("YYYY-MM-DD HH:mm:ss"),eventTimezone:"America/New_York",paymentGatewayType:"TRUST_COMMERCE",registrantTypes:[{id:uuid(),name:"Default",conferenceId:newConferenceId,cost:0,earlyRegistrationCutoff:moment().add(7,"days").format("YYYY-MM-DD HH:mm:ss")}],registrationPages:[{id:newPageId,conferenceId:newConferenceId,title:"Your Information",position:0,blocks:[{id:uuid(),pageId:newPageId,type:"nameQuestion",profileType:"NAME",title:"Name",position:0,required:!0},{id:uuid(),pageId:newPageId,type:"emailQuestion",title:"Email",profileType:"EMAIL",position:1,required:!0}]}]};return $http.post(path(),data).then(function(response){if(201===response.status){var conference=response.data;return cache.removeAll(),conference}alert("Error creating conference. "+response.data.errorMessage+": "+response.data.customErrorMessage)})}}),angular.module("confRegistrationWebApp").factory("currentRegistrationInterceptor",function($q,$injector){return{responseError:function(rejection){var regExp=/conferences\/[-a-zA-Z0-9]+\/registrations\/current\/?$/;if(404===rejection.status&&regExp.test(rejection.config.url)){var url=rejection.config.url.split("/");return _.isEmpty(_.last(url))&&url.pop(),url.pop(),$injector.get("$http").post(url.join("/"),{})}return $q.reject(rejection)}}}),angular.module("confRegistrationWebApp").factory("debouncePutsInterceptor",function($timeout){var waitingRequests={},passThrough=function(config){var fn=function(){waitingRequests[config.url].holdRequests=!1};waitingRequests[config.url]={holdRequests:!0,timer:$timeout(fn,200)}},holdRequest=function(config){$timeout.cancel(waitingRequests[config.url].timer);var fn=function(){return waitingRequests[config.url].holdRequests=!1,config};return waitingRequests[config.url].timer=$timeout(fn,200),waitingRequests[config.url].timer};return{request:function(config){var deferredConfig;return"PUT"===config.method&&(waitingRequests[config.url]&&waitingRequests[config.url].holdRequests?deferredConfig=holdRequest(config):passThrough(config)),deferredConfig||config}}}),angular.module("confRegistrationWebApp").constant("enforceAuth",function($rootScope,$route,$modal,$cookies,$q,$location,$window,apiUrl,$http,ProfileCache){var defer=$q.defer(),noAuthControllers=["RegistrationCtrl","paymentCtrl","ReviewRegistrationCtrl"],loginDialogOptions={templateUrl:"views/modals/41638c29.dee070a1.loginDialog.html",controller:"LoginDialogCtrl",backdrop:"static",keyboard:!1};return/^\/auth\/.*/.test($location.url())||($cookies.intendedRoute=$location.path(),angular.isDefined($route.current.params.regType)&&($cookies.regType=$route.current.params.regType)),noAuthControllers.indexOf($route.current.$$route.controller)>=0?angular.isDefined($cookies.crsToken)&&""!==$cookies.crsToken?defer.resolve("Authorization present."):$http.get("conferences/"+$route.current.params.conferenceId).success(function(conference){conference.requireLogin?$modal.open(loginDialogOptions):$window.location.href=apiUrl+"auth/none/login"}):angular.isDefined($cookies.crsToken)&&""!==$cookies.crsToken&&"NONE"!==$cookies.crsAuthProviderType?(defer.resolve("Authorization present."),angular.isUndefined($rootScope.globalGreetingName)&&ProfileCache.getCache(function(data){$rootScope.globalGreetingName=data.firstName})):($modal.open(loginDialogOptions),$rootScope.loadingMsg=""),defer.promise}),angular.module("confRegistrationWebApp").service("GrowlService",function GrowlService($rootScope,$timeout){var growlScope,growlObject,growlName,growlTimeout;this.growl=function(scope,name,object,message){growlName=name,growlScope=scope,growlObject=angular.copy(object),$rootScope.growlMessage=message,$timeout.cancel(growlTimeout),growlTimeout=$timeout(function(){$rootScope.growlMessage=""},6e3)},$rootScope.growlUndo=function(){eval("growlScope."+growlName+" = growlObject;"),$rootScope.growlMessage="",$timeout.cancel(growlTimeout)}}),angular.module("confRegistrationWebApp").factory("statusInterceptor",function(){return{response:function(response){return _.isUndefined(response.data.statusCode)||(response.status=response.data.statusCode),response}}}),angular.module("confRegistrationWebApp").factory("httpUrlInterceptor",function(apiUrl){return{request:function(config){var passthroughRegexs=[/https?:\/\/.*/,/^views\/.*/,/template\/.*/],match=function(regexp){return regexp.test(config.url)};return _.any(passthroughRegexs,match)||(config.url=apiUrl+config.url),config}}}),angular.module("confRegistrationWebApp").service("Model",function($cacheFactory,$rootScope,$http,$q){var cache=$cacheFactory("cache"),thisModel=this;this.create=function(path,object){return $http.post(path,object).then(function(response){var createdObjectPath=response.headers("Location"),createdObject=response.data;return cache.put(createdObjectPath,createdObject),cache.get(path)&&thisModel.get(path).then(function(parentCollection){parentCollection.push(createdObject),cache.put(path,parentCollection),$rootScope.$broadcast(path,parentCollection)}),angular.copy(createdObject)})},this.get=function(path){return cache.get(path)?$q.when(angular.copy(cache.get(path))):$http.get(path).then(function(response){return cache.put(path,response.data),angular.copy(response.data)})},this["delete"]=function(path){$http["delete"](path).then(function(){cache.remove(path),$rootScope.$broadcast(path);var match=/\/?(.*\/)(.+)$/.exec(path),parentPath=match[1],removedObjectId=match[2];cache.get(parentPath)&&thisModel.get(parentPath).then(function(oldParentCollection){var parentCollection=_.reject(oldParentCollection,{id:removedObjectId});cache.put(parentPath,parentCollection),$rootScope.$broadcast(parentPath,parentCollection)})})},this.subscribe=function(scope,name,path){scope.$watch(name,function(object){if(angular.isDefined(object)){var cb=function(){cache.put(path,angular.copy(object)),$rootScope.$broadcast(path,object,scope.$id)};thisModel.update(path,object,cb)}},!0),scope.$on(path,function(event,object,originScopeId){scope.$id!==originScopeId&&(scope[name]=angular.copy(object))}),thisModel.get(path).then(function(object){scope[name]=angular.copy(object)})},this.update=function(path,object,cb){var callback=cb||function(){cache.put(path,angular.copy(object)),$rootScope.$broadcast(path,object)};angular.equals(object,cache.get(path))||$http.put(path,object).then(callback)}}),angular.module("confRegistrationWebApp").service("PermissionCache",function($cacheFactory,$rootScope,$http,$q){var cache=$cacheFactory("permission"),path=function(conferenceId){return"conferences/"+conferenceId+"/permissions/current"},update=function(path,object){cache.put(path,object),$rootScope.$broadcast(path,object)},checkCache=function(path,callback){var cachedObject=cache.get(path);angular.isDefined(cachedObject)?callback(cachedObject,path):$http.get(path).success(function(data){switch(data.permissionLevel){case"CREATOR":data.permissionInt=4;break;case"FULL":data.permissionInt=3;break;case"UPDATE":data.permissionInt=2;break;case"VIEW":data.permissionInt=1;break;default:data.permissionInt=0}update(path,data),callback(data,path)})};this.getForConference=function(conferenceId){var defer=$q.defer();return checkCache(path(conferenceId),defer.resolve),defer.promise}}),angular.module("confRegistrationWebApp").constant("permissionConstants",{CREATOR:4,FULL:3,UPDATE:2,VIEW:1,NONE:0}),angular.module("confRegistrationWebApp").service("ProfileCache",function($cacheFactory,$rootScope,$http,$q){var cache=$cacheFactory("profile"),path="profile",checkCache=function(path,callback){var cachedObject=cache.get(path);angular.isDefined(cachedObject)?callback(cachedObject,path):$http.get(path).success(function(profileData){cache.put(path,profileData),callback(profileData,path)})};this.get=function(){var defer=$q.defer();return checkCache(path,function(profileData){defer.resolve(profileData)}),defer.promise},this.getCache=function(callback){checkCache(path,function(profileData){callback(profileData)})}}),angular.module("confRegistrationWebApp").service("RegistrationCache",function($cacheFactory,$rootScope,$http,$q){var cache=$cacheFactory("registration"),path=function(id){return"registrations/"+(id||"")},update=function(path,object){cache.put(path,angular.copy(object)),$rootScope.$broadcast(path,object)},checkCache=function(path,callback){var cachedObject=cache.get(path);angular.isDefined(cachedObject)?callback(cachedObject,path):$http.get(path).success(function(data){update(path,data),callback(data,path)})};this.update=function(path,registration,cb,errorCallback){if("preview"===$rootScope.registerMode)return $rootScope.previewRegCache=registration,void cb();var callback=cb||function(){cache.put(path,angular.copy(registration)),$rootScope.broadcast(path,registration)},cachedReg=cache.get(path);angular.equals(registration,cachedReg)||$http.put(path,registration).then(callback,errorCallback)},this.query=function(id){checkCache(path(id),function(conferences,path){$rootScope.$broadcast(path,conferences)})},this.emptyCache=function(){cache.removeAll()},this.get=function(id){var defer=$q.defer();return checkCache(path(id),defer.resolve),defer.promise},this.getCurrent=function(conferenceId){var defer=$q.defer();return checkCache("conferences/"+conferenceId+"/registrations/current",function(registration){"preview"===$rootScope.registerMode&&(angular.isUndefined($rootScope.previewRegCache)?(registration.completed=!1,registration.registrants=[],$rootScope.previewRegCache=registration):registration=$rootScope.previewRegCache),update(path(registration.id),registration),defer.resolve(registration)}),defer.promise},this.getAllForConference=function(conferenceId,blocks){var defer=$q.defer();$rootScope.loadingMsg="Loading Registrations";var blocksStr="";return _.isEmpty(blocks)||(blocksStr="?block="+blocks.join("&block=")),$http.get("conferences/"+conferenceId+"/registrations"+blocksStr).success(function(registrations){$rootScope.loadingMsg="",defer.resolve(registrations)}).error(function(){$rootScope.loadingMsg=""}),defer.promise}}),angular.module("confRegistrationWebApp").factory("unauthorizedInterceptor",function($q,$cookies){return{responseError:function(rejection){return _.contains([401,0],rejection.status)&&angular.isDefined($cookies.crsToken)&&(delete $cookies.crsToken,delete $cookies.crsPreviousToken,location.reload()),$q.reject(rejection)}}}),angular.module("confRegistrationWebApp").constant("uuid",function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=16*Math.random()|0,v="x"==c?r:3&r|8;return v.toString(16)})}),angular.module("confRegistrationWebApp").service("validateRegistrant",function(){this.validate=function(conference,registrant){var invalidBlocks=[];return conference=angular.copy(conference),angular.forEach(conference.registrationPages,function(page){var pageIndex=_.findIndex(conference.registrationPages,{id:page.id});angular.forEach(angular.copy(page.blocks),function(block){_.contains(block.registrantTypes,registrant.registrantTypeId)&&_.remove(conference.registrationPages[pageIndex].blocks,function(b){return b.id===block.id})})}),angular.forEach(_.flatten(conference.registrationPages,"blocks"),function(block){if(block.required){var answer=_.find(registrant.answers,{blockId:block.id});if(angular.isUndefined(answer))return void invalidBlocks.push(block.id);switch(answer=answer.value,block.type){case"nameQuestion":if(angular.isUndefined(answer.firstName)||angular.isUndefined(answer.lastName))return void invalidBlocks.push(block.id);if(_.isEmpty(answer.firstName)||_.isEmpty(answer.lastName))return void invalidBlocks.push(block.id);break;case"numberQuestion":if(angular.isUndefined(answer))return void invalidBlocks.push(block.id);if(!_.isNumber(answer))return void invalidBlocks.push(block.id);break;case"phoneQuestion":if(angular.isUndefined(answer)||_.isNull(answer))return void invalidBlocks.push(block.id);if(_.isNull(answer.match(/^(\D*\d\D*){10,15}$/g)))return void invalidBlocks.push(block.id);break;default:if(angular.isUndefined(answer))return void invalidBlocks.push(block.id);if(_.isEmpty(answer))return void invalidBlocks.push(block.id)}}}),invalidBlocks}});